<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœ¬åœ°é è¦½PDFç‰ˆ v5 (CDN)</title>

    <!-- PDF.js å®˜æ–¹ CSS (CDN) -->
    <link
      rel="stylesheet"
      href="pdfjs-assets-v5.4.530/pdf_viewer.css"
    />

    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
      :root {
        --main-color: #0078d7;
        --button-hover-color: #005a9e;
        --button-active-color: #004275;
      }

      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      }

      #viewerContainer {
        position: absolute;
        top: 40px; /* å¢åŠ é«˜åº¦çµ¦å·¥å…·åˆ— */
        bottom: 0;
        left: 0;
        right: 0;
        overflow: auto;
        background-color: #525659;
      }

      #viewer {
        position: relative;
      }

      .toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background-color: #474747;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 10px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .toolbar-left, .toolbar-center, .toolbar-right {
        display: flex;
        align-items: center;
      }

      .toolbar-left {
        flex: 1.5; /* å¢åŠ ç©ºé–“çµ¦æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• */
      }

      .toolbar-center {
        flex: 1;
        justify-content: center;
      }

      .toolbar-right {
        flex: 1;
        justify-content: flex-end;
      }

      .toolbar button, .toolbar label.btn {
        background-color: transparent;
        border: none;
        color: white;
        padding: 6px 10px;
        margin: 0 2px;
        cursor: pointer;
        border-radius: 2px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
      }

      .toolbar label.btn {
        background-color: var(--main-color);
        margin-right: 15px;
      }

      .toolbar button:hover, .toolbar label.btn:hover {
        background-color: var(--button-hover-color);
      }

      .toolbar button:active, .toolbar label.btn:active {
        background-color: var(--button-active-color);
      }

      /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
      #fileInput {
        display: none;
      }

      .page-controls {
        display: flex;
        align-items: center;
      }

      #pageNumber {
        width: 40px;
        text-align: center;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 2px;
        padding: 3px;
        margin: 0 5px;
      }

      .zoom-controls {
        display: flex;
        align-items: center;
        margin: 0 10px;
      }

      #zoomValue {
        margin: 0 5px;
        min-width: 45px;
        text-align: center;
      }

      #loadingBar {
        position: absolute;
        top: 40px;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        z-index: 1001;
        display: none;
      }

      #loadingBar .progress {
        width: 0%;
        height: 100%;
        background-color: var(--main-color);
        transition: width 0.2s;
      }

      #viewerContainer {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media print {
        /* éš±è—æ‰€æœ‰é é¢å…§å®¹ */
        .toolbar, #viewerContainer, #loadingBar {
          display: none !important;
        }

        /* é¡¯ç¤ºåˆ—å°é®è”½å±¤ */
        #print-overlay {
          display: flex !important;
        }

        /* ä¿®æ­£ï¼šåˆ—å°æ™‚å¼·åˆ¶ç§»é™¤æ¨¡ç³Šæ¿¾é¡ï¼Œé¿å…é®è”½å±¤ä¹Ÿè¢«æ¨¡ç³Š */
        body.blurred {
          filter: none !important;
          -webkit-filter: none !important;
        }
      }

      /* åˆ—å°é®è”½å±¤æ¨£å¼ */
      #print-overlay {
        display: none; /* å¹³æ™‚éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .print-warning .icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .print-warning h1 {
        color: #d32f2f; /* ç´…è‰²è­¦å‘Š */
        font-size: 32px;
        margin: 0;
        font-weight: bold;
      }

      .print-warning p {
        color: #555;
        font-size: 18px;
        margin-top: 10px;
      }

      /* è¦–çª—å¤±å»ç„¦é»æ™‚çš„æ¨¡ç³Šæ•ˆæœ */
      .blurred {
        /* ä½¿ç”¨é«˜æ–¯æ¨¡ç³Š + é™ä½äº®åº¦ (æ¨¡æ“¬æ·±è‰²æ¯›ç»ç’ƒæ•ˆæœï¼Œé¿å…åˆºçœ¼) */
        filter: blur(20px) brightness(0.6);
        -webkit-filter: blur(20px) brightness(0.6);
        pointer-events: none; /* é˜²æ­¢åœ¨æ¨¡ç³Šç‹€æ…‹ä¸‹è¢«é»æ“Š */
        transition: filter 0.3s ease; /* å¢åŠ éæ¸¡æ™‚é–“è®“æ•ˆæœæ›´æŸ”å’Œ */
      }

      /* å¯†ç¢¼è¼¸å…¥å°è©±æ¡†æ¨£å¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: #3a3a3a;
        color: white;
        padding: 20px 30px;
        border-radius: 4px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        min-width: 300px;
        text-align: center;
      }

      .modal-content h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .modal-content p {
        margin-bottom: 15px;
        font-size: 14px;
        color: #ddd;
      }

      .password-input-container {
        position: relative;
        width: 100%;
        margin-bottom: 20px;
      }

      .modal-content input#modalPasswordInput {
        width: 100%;
        padding: 8px;
        padding-right: 35px; /* ç‚ºçœ¼ç›åœ–ç¤ºç•™ç©ºé–“ */
        border: 1px solid #555;
        border-radius: 2px;
        background-color: #222;
        color: white;
        box-sizing: border-box;
      }

      .modal-content input#modalPasswordInput:focus {
        outline: none;
        border-color: var(--main-color);
      }

      .modal-content input#modalPasswordInput.error {
        border-color: #f44336;
      }

      .error-text {
        color: #ff5252 !important;
        font-weight: bold;
      }

      .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        user-select: none;
        font-size: 18px;
        opacity: 0.8;
        transition: all 0.2s ease;
      }

      .toggle-password:hover {
        opacity: 1;
        transform: translateY(-50%) scale(1.2);
      }

      .toggle-password:active {
        transform: translateY(-50%) scale(0.9);
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-buttons button {
        padding: 6px 15px;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-cancel {
        background-color: #555;
        color: white;
      }

      .btn-cancel:hover {
        background-color: #666;
      }

      .btn-confirm {
        background-color: var(--main-color);
        color: white;
      }

      .btn-confirm:hover {
        background-color: var(--button-hover-color);
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="toolbar-left">
        <!-- æ–°å¢ï¼šæª”æ¡ˆé¸å–æŒ‰éˆ• -->
        <label for="fileInput" class="btn" title="é–‹å•Ÿæœ¬åœ° PDF æª”æ¡ˆ">
          <span>ğŸ“‚ é–‹å•Ÿ PDF</span>
        </label>
        <input type="file" id="fileInput" accept=".pdf" />

        <div class="page-controls">
          <button id="previous" title="ä¸Šä¸€é ">â—€</button>
          <input type="number" id="pageNumber" min="1" value="1" />
          <span>/</span>
          <span id="numPages">0</span>
          <button id="next" title="ä¸‹ä¸€é ">â–¶</button>
        </div>
      </div>

      <div class="toolbar-center">
        <div class="zoom-controls">
          <button id="zoomOut" title="ç¸®å°">ï¼</button>
          <span id="zoomValue">100%</span>
          <button id="zoomIn" title="æ”¾å¤§">ï¼‹</button>
        </div>
      </div>

      <div class="toolbar-right">
        <button id="print" title="åˆ—å°">åˆ—å°</button>
        <button id="download" title="ä¸‹è¼‰">ä¸‹è¼‰</button>
      </div>
    </div>

    <div id="loadingBar">
      <div class="progress"></div>
    </div>

    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <!-- åˆ—å°é®è”½å±¤ (é è¨­éš±è—ï¼Œåƒ…åˆ—å°æ™‚é¡¯ç¤º) -->
    <div id="print-overlay">
      <div class="print-warning">
        <div class="icon">ğŸš«</div>
        <h1>æ©Ÿå¯†æ–‡ä»¶ ç¦æ­¢åˆ—å°</h1>
        <p>Confidential - Printing Prohibited</p>
      </div>
    </div>

    <!-- å¯†ç¢¼è¼¸å…¥å°è©±æ¡† -->
    <div id="passwordModal" class="modal-overlay">
      <div class="modal-content">
        <h3>æ–‡ä»¶å—ä¿è­·</h3>
        <p id="passwordPromptMsg">è«‹è¼¸å…¥å¯†ç¢¼ä»¥é–‹å•Ÿæ­¤æ–‡ä»¶ï¼š</p>
        <div class="password-input-container">
          <input
            type="password"
            id="modalPasswordInput"
            placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
          />
          <span id="togglePassword" class="toggle-password" title="é¡¯ç¤ºå¯†ç¢¼">ğŸ‘€</span>
        </div>
        <div class="modal-buttons">
          <button id="modalCancelBtn" class="btn-cancel">å–æ¶ˆ</button>
          <button id="modalConfirmBtn" class="btn-confirm">ç¢ºèª</button>
        </div>
      </div>
    </div>

    <!-- PDF.js å®˜æ–¹ JS (ä½¿ç”¨ CDN èˆ‡ ESM) -->
    <script type="module">
      import {
        getDocument,
        GlobalWorkerOptions,
        PasswordResponses,
      } from './pdfjs-assets-v5.4.530/pdf.mjs';
      import {
        PDFViewer,
        EventBus,
        PDFLinkService,
        PDFFindController,
      } from './pdfjs-assets-v5.4.530/pdf_viewer.mjs';

      // è¨­å®š PDF.js çš„ worker è·¯å¾‘
      GlobalWorkerOptions.workerSrc = './pdfjs-assets-v5.4.530/pdf.worker.mjs';

      class PDFViewerApp {
        constructor() {
          this.pdfDoc = null;
          this.pageNum = 1;
          this.scale = 1.0;
          this.pdfViewer = null;
          this.pdfLinkService = null;
          this.eventBus = null;
          this.currentPasswordCallback = null;

          // DOM å…ƒç´ å¿«å–
          this.ui = {
            container: document.getElementById('viewerContainer'),
            pageNumberInput: document.getElementById('pageNumber'),
            numPages: document.getElementById('numPages'),
            previousButton: document.getElementById('previous'),
            nextButton: document.getElementById('next'),
            zoomInButton: document.getElementById('zoomIn'),
            zoomOutButton: document.getElementById('zoomOut'),
            zoomValueSpan: document.getElementById('zoomValue'),
            printButton: document.getElementById('print'),
            downloadButton: document.getElementById('download'),
            loadingBar: document.getElementById('loadingBar'),
            loadingBarProgress: document.querySelector('#loadingBar .progress'),
            fileInput: document.getElementById('fileInput'),
            passwordModal: document.getElementById('passwordModal'),
            modalPasswordInput: document.getElementById('modalPasswordInput'),
            modalConfirmBtn: document.getElementById('modalConfirmBtn'),
            modalCancelBtn: document.getElementById('modalCancelBtn'),
            passwordPromptMsg: document.getElementById('passwordPromptMsg'),
            togglePassword: document.getElementById('togglePassword'),
          };

          this.init();
        }

        init() {
          this.initEventBus();
          this.createPdfViewer();
          this.bindEvents();
          this.setupSecurity();
        }

        initEventBus() {
          this.eventBus = new EventBus();

          // ç›£è½é é¢è®Šæ›´
          this.eventBus.on('pagechanging', (evt) => {
            this.pageNum = evt.pageNumber;
            this.updateUI();
          });

          // ç›£è½ç¸®æ”¾è®Šæ›´
          this.eventBus.on('scalechanging', (evt) => {
            this.scale = evt.scale;
            this.updateZoomValue();
          });

          // ç›£è½è¼‰å…¥é€²åº¦
          this.eventBus.on('progress', (evt) => {
            if (evt.total > 0) {
              const percent = Math.round((evt.loaded / evt.total) * 100);
              this.ui.loadingBarProgress.style.width = percent + '%';
            }
          });

          // ç›£è½æ–‡ä»¶è¼‰å…¥å®Œæˆ
          this.eventBus.on('documentloaded', () => {
            this.ui.loadingBar.style.display = 'none';
          });
          
          // é é¢åˆå§‹åŒ–å®Œæˆå¾Œï¼Œè‡ªå‹•èª¿æ•´ç¸®æ”¾
          this.eventBus.on('pagesinit', () => {
            this.pdfViewer.currentScaleValue = 'auto';
          });
        }

        createPdfViewer() {
          this.ui.container.textContent = '';
          const viewerDiv = document.createElement('div');
          viewerDiv.id = 'viewer';
          viewerDiv.className = 'pdfViewer';
          this.ui.container.appendChild(viewerDiv);

          this.pdfLinkService = new PDFLinkService({
            eventBus: this.eventBus,
          });

          const findController = new PDFFindController({
            eventBus: this.eventBus,
            linkService: this.pdfLinkService,
          });

          this.pdfViewer = new PDFViewer({
            container: this.ui.container,
            eventBus: this.eventBus,
            linkService: this.pdfLinkService,
            findController: findController,
            renderer: 'canvas',
            textLayerMode: 2,
          });

          this.pdfLinkService.setViewer(this.pdfViewer);
        }

        async loadPdf(source) {
          this.ui.loadingBar.style.display = 'block';
          this.ui.loadingBarProgress.style.width = '0%';

          const params =
            typeof source === 'string' ? { url: source } : { data: source };

          // å»ºç«‹ Loading Task
          const loadingTask = getDocument(params);

          // è¨­å®šå¯†ç¢¼å›èª¿
          loadingTask.onPassword = (updatePassword, reason) => {
            this.handlePasswordRequest(updatePassword, reason);
          };

          try {
            const pdf = await loadingTask.promise;

            // éŠ·æ¯€èˆŠæ–‡ä»¶
            if (this.pdfDoc) {
              this.pdfDoc.destroy();
            }

            // é‡å»º Viewer (ç¢ºä¿ç‹€æ…‹ä¹¾æ·¨)
            this.createPdfViewer();

            this.pdfDoc = pdf;
            this.ui.numPages.textContent = pdf.numPages;
            this.pdfViewer.setDocument(pdf);
            this.pdfLinkService.setDocument(pdf);

            // é‡ç½®ç‹€æ…‹
            this.pageNum = 1;
            this.scale = 1.0;
            
            this.updateUI();
            this.hidePasswordModal();
            console.log('PDF è¼‰å…¥æˆåŠŸ');

          } catch (error) {
            console.error('è¼‰å…¥ PDF å¤±æ•—:', error);
            this.hidePasswordModal();
            
            let msg = 'è¼‰å…¥å¤±æ•—: ' + error.message;
            if (typeof source === 'string' && window.location.protocol === 'file:') {
               msg += '\n\néŒ¯èª¤ï¼šè«‹ä½¿ç”¨ HTTP Server åŸ·è¡Œæ­¤ v5 ç‰ˆæœ¬ (ESM)ï¼Œæˆ–æ”¹ç”¨æ”¯æ´ file:// çš„ v3 ç‰ˆæœ¬ã€‚';
            }
            alert(msg);
            this.ui.loadingBar.style.display = 'none';
          }
        }

        handlePasswordRequest(updatePassword, reason) {
          console.log('éœ€è¦å¯†ç¢¼ï¼ŒåŸå› ä»£ç¢¼:', reason);
          this.currentPasswordCallback = updatePassword;
          
          let msg = 'è«‹è¼¸å…¥å¯†ç¢¼ä»¥é–‹å•Ÿæ­¤æ–‡ä»¶ï¼š';
          const PASSWORD_INCORRECT = PasswordResponses?.INCORRECT_PASSWORD || 1;

          if (reason === PASSWORD_INCORRECT) {
            msg = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼š';
            this.ui.modalPasswordInput.value = '';
            this.ui.modalPasswordInput.classList.add('error');
            this.ui.passwordPromptMsg.classList.add('error-text');
          } else {
            this.ui.modalPasswordInput.value = '';
            this.ui.modalPasswordInput.classList.remove('error');
            this.ui.passwordPromptMsg.classList.remove('error-text');
          }

          this.ui.passwordPromptMsg.textContent = msg;
          this.ui.passwordModal.style.display = 'flex';
          this.ui.modalPasswordInput.focus();
        }

        submitPassword() {
          const password = this.ui.modalPasswordInput.value;
          if (this.currentPasswordCallback) {
            this.ui.passwordModal.style.display = 'none';
            this.currentPasswordCallback(password);
          }
        }

        cancelPassword() {
          if (this.currentPasswordCallback) {
            console.log('ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥å¯†ç¢¼');
            this.currentPasswordCallback('');
          }
          this.hidePasswordModal();
          this.ui.loadingBar.style.display = 'none';
        }

        hidePasswordModal() {
          this.ui.passwordModal.style.display = 'none';
          this.currentPasswordCallback = null;
        }

        updateUI() {
          this.ui.pageNumberInput.value = this.pageNum;
          this.ui.previousButton.disabled = this.pageNum <= 1;
          this.ui.nextButton.disabled =
            !this.pdfDoc || this.pageNum >= this.pdfDoc.numPages;
        }

        updateZoomValue() {
          this.ui.zoomValueSpan.textContent = Math.round(this.scale * 100) + '%';
        }

        bindEvents() {
          // ç¿»é æ§åˆ¶
          this.ui.previousButton.addEventListener('click', () => {
            if (this.pageNum > 1) {
              this.pageNum--;
              this.pdfViewer.currentPageNumber = this.pageNum;
            }
          });

          this.ui.nextButton.addEventListener('click', () => {
            if (this.pdfDoc && this.pageNum < this.pdfDoc.numPages) {
              this.pageNum++;
              this.pdfViewer.currentPageNumber = this.pageNum;
            }
          });

          this.ui.pageNumberInput.addEventListener('change', (e) => {
            const val = parseInt(e.target.value);
            if (this.pdfDoc && val >= 1 && val <= this.pdfDoc.numPages) {
              this.pageNum = val;
              this.pdfViewer.currentPageNumber = this.pageNum;
            } else {
              e.target.value = this.pageNum;
            }
          });

          // ç¸®æ”¾æ§åˆ¶
          this.ui.zoomInButton.addEventListener('click', () => {
            this.scale = Math.min(5, this.scale * 1.1);
            this.pdfViewer.currentScale = this.scale;
          });

          this.ui.zoomOutButton.addEventListener('click', () => {
            this.scale = Math.max(0.1, this.scale / 1.1);
            this.pdfViewer.currentScale = this.scale;
          });

          // æª”æ¡ˆä¸Šå‚³
          this.ui.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              const fileReader = new FileReader();
              fileReader.onload = () => {
                this.loadPdf(new Uint8Array(fileReader.result));
              };
              fileReader.readAsArrayBuffer(file);
            }
          });

          // åˆ—å°èˆ‡ä¸‹è¼‰ (ç¦ç”¨)
          const alertDisabled = (msg) => alert(msg);
          this.ui.printButton.addEventListener('click', () =>
            alertDisabled('æœ¬ç³»çµ±å·²ç¦ç”¨åˆ—å°åŠŸèƒ½ã€‚')
          );
          this.ui.downloadButton.addEventListener('click', () =>
            alertDisabled('æœ¬ç³»çµ±å·²ç¦ç”¨ä¸‹è¼‰åŠŸèƒ½ã€‚')
          );

          // å¯†ç¢¼ Modal äº‹ä»¶
          this.ui.modalConfirmBtn.addEventListener('click', () =>
            this.submitPassword()
          );
          this.ui.modalCancelBtn.addEventListener('click', () =>
            this.cancelPassword()
          );
          this.ui.modalPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') this.submitPassword();
            else if (e.key === 'Escape') this.cancelPassword();
          });

          // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
          const showPass = () => (this.ui.modalPasswordInput.type = 'text');
          const hidePass = () => (this.ui.modalPasswordInput.type = 'password');

          this.ui.togglePassword.addEventListener('mousedown', showPass);
          this.ui.togglePassword.addEventListener('mouseup', hidePass);
          this.ui.togglePassword.addEventListener('mouseleave', hidePass);
          
          this.ui.togglePassword.addEventListener('touchstart', (e) => {
            e.preventDefault();
            showPass();
          });
          this.ui.togglePassword.addEventListener('touchend', (e) => {
             e.preventDefault();
             hidePass();
          });
        }

        setupSecurity() {
          // ç¦ç”¨å³éµ
          document.addEventListener('contextmenu', (e) => e.preventDefault());

          // ç¦ç”¨å¿«æ·éµ
          document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
              e.preventDefault();
              alert('æœ¬ç³»çµ±å·²ç¦ç”¨åˆ—å°åŠŸèƒ½ã€‚');
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
              e.preventDefault();
              alert('æœ¬ç³»çµ±å·²ç¦ç”¨å„²å­˜åŠŸèƒ½ã€‚');
            }
          });

          // æ¨¡ç³Šæ•ˆæœ
          window.addEventListener('blur', () => {
            document.body.classList.add('blurred');
            document.title = 'å…§å®¹ä¿è­·ä¸­...';
          });

          window.addEventListener('focus', () => {
            document.body.classList.remove('blurred');
            document.title = 'æœ¬åœ°é è¦½PDFç‰ˆ';
          });
        }
      }

      // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
      const app = new PDFViewerApp();
      
      // é–‹æ”¾çµ¦å…¨åŸŸä»¥ä¾¿é™¤éŒ¯ (å¯é¸)
      window.pdfApp = app;
    </script>
  </body>
</html>
