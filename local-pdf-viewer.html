<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœ¬åœ°é è¦½PDFç‰ˆ</title>

    <!-- PDF.js å®˜æ–¹ CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/web/pdf_viewer.css"
    />

    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
      :root {
        --main-color: #0078d7;
        --button-hover-color: #005a9e;
        --button-active-color: #004275;
      }

      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      }

      #viewerContainer {
        position: absolute;
        top: 40px; /* å¢åŠ é«˜åº¦çµ¦å·¥å…·åˆ— */
        bottom: 0;
        left: 0;
        right: 0;
        overflow: auto;
        background-color: #525659;
      }

      #viewer {
        position: relative;
      }

      .toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background-color: #474747;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 10px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .toolbar-left,
      .toolbar-center,
      .toolbar-right {
        display: flex;
        align-items: center;
      }

      .toolbar-left {
        flex: 1.5; /* å¢åŠ ç©ºé–“çµ¦æª”æ¡ˆä¸Šå‚³æŒ‰éˆ• */
      }

      .toolbar-center {
        flex: 1;
        justify-content: center;
      }

      .toolbar-right {
        flex: 1;
        justify-content: flex-end;
      }

      .toolbar button,
      .toolbar label.btn {
        background-color: transparent;
        border: none;
        color: white;
        padding: 6px 10px;
        margin: 0 2px;
        cursor: pointer;
        border-radius: 2px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
      }

      .toolbar label.btn {
        background-color: var(--main-color);
        margin-right: 15px;
      }

      .toolbar button:hover,
      .toolbar label.btn:hover {
        background-color: var(--button-hover-color);
      }

      .toolbar button:active,
      .toolbar label.btn:active {
        background-color: var(--button-active-color);
      }

      /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
      #fileInput {
        display: none;
      }

      .page-controls {
        display: flex;
        align-items: center;
      }

      #pageNumber {
        width: 40px;
        text-align: center;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 2px;
        padding: 3px;
        margin: 0 5px;
      }

      .zoom-controls {
        display: flex;
        align-items: center;
        margin: 0 10px;
      }

      #zoomValue {
        margin: 0 5px;
        min-width: 45px;
        text-align: center;
      }

      #loadingBar {
        position: absolute;
        top: 40px;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        z-index: 1001;
        display: none;
      }

      #loadingBar .progress {
        width: 0%;
        height: 100%;
        background-color: var(--main-color);
        transition: width 0.2s;
      }

      #viewerContainer {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media print {
        /* éš±è—æ‰€æœ‰é é¢å…§å®¹ */
        .toolbar,
        #viewerContainer,
        #loadingBar {
          display: none !important;
        }
        
        /* é¡¯ç¤ºåˆ—å°é®è”½å±¤ */
        #print-overlay {
          display: flex !important;
        }

        /* ä¿®æ­£ï¼šåˆ—å°æ™‚å¼·åˆ¶ç§»é™¤æ¨¡ç³Šæ¿¾é¡ï¼Œé¿å…é®è”½å±¤ä¹Ÿè¢«æ¨¡ç³Š */
        body.blurred {
          filter: none !important;
          -webkit-filter: none !important;
        }
      }

      /* åˆ—å°é®è”½å±¤æ¨£å¼ */
      #print-overlay {
        display: none; /* å¹³æ™‚éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .print-warning .icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .print-warning h1 {
        color: #d32f2f; /* ç´…è‰²è­¦å‘Š */
        font-size: 32px;
        margin: 0;
        font-weight: bold;
      }

      .print-warning p {
        color: #555;
        font-size: 18px;
        margin-top: 10px;
      }

      /* è¦–çª—å¤±å»ç„¦é»æ™‚çš„æ¨¡ç³Šæ•ˆæœ */
      .blurred {
        /* ä½¿ç”¨é«˜æ–¯æ¨¡ç³Š + é™ä½äº®åº¦ (æ¨¡æ“¬æ·±è‰²æ¯›ç»ç’ƒæ•ˆæœï¼Œé¿å…åˆºçœ¼) */
        filter: blur(20px) brightness(0.6);
        -webkit-filter: blur(20px) brightness(0.6);
        pointer-events: none; /* é˜²æ­¢åœ¨æ¨¡ç³Šç‹€æ…‹ä¸‹è¢«é»æ“Š */
        transition: filter 0.3s ease; /* å¢åŠ éæ¸¡æ™‚é–“è®“æ•ˆæœæ›´æŸ”å’Œ */
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <div class="toolbar-left">
        <!-- æ–°å¢ï¼šæª”æ¡ˆé¸å–æŒ‰éˆ• -->
        <label for="fileInput" class="btn" title="é–‹å•Ÿæœ¬åœ° PDF æª”æ¡ˆ">
          <span>ğŸ“‚ é–‹å•Ÿ PDF</span>
        </label>
        <input type="file" id="fileInput" accept=".pdf" />

        <div class="page-controls">
          <button id="previous" title="ä¸Šä¸€é ">â—€</button>
          <input type="number" id="pageNumber" min="1" value="1" />
          <span>/</span>
          <span id="numPages">0</span>
          <button id="next" title="ä¸‹ä¸€é ">â–¶</button>
        </div>
      </div>

      <div class="toolbar-center">
        <div class="zoom-controls">
          <button id="zoomOut" title="ç¸®å°">ï¼</button>
          <span id="zoomValue">100%</span>
          <button id="zoomIn" title="æ”¾å¤§">ï¼‹</button>
        </div>
      </div>

      <div class="toolbar-right">
        <button id="print" title="åˆ—å°">åˆ—å°</button>
        <button id="download" title="ä¸‹è¼‰">ä¸‹è¼‰</button>
      </div>
    </div>

    <div id="loadingBar">
      <div class="progress"></div>
    </div>

    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <!-- åˆ—å°é®è”½å±¤ (é è¨­éš±è—ï¼Œåƒ…åˆ—å°æ™‚é¡¯ç¤º) -->
    <div id="print-overlay">
      <div class="print-warning">
        <div class="icon">ğŸš«</div>
        <h1>æ©Ÿå¯†æ–‡ä»¶ ç¦æ­¢åˆ—å°</h1>
        <p>Confidential - Printing Prohibited</p>
      </div>
    </div>

    <!-- PDF.js å®˜æ–¹ JS -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/web/pdf_viewer.js"></script>

    <script>
      // è¨­å®š PDF.js çš„ worker è·¯å¾‘
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

      // è®Šæ•¸å®šç¾©
      let pdfDoc = null;
      let pageNum = 1;
      let scale = 1.0;
      let pdfViewer = null;
      let pdfLinkService = null;
      let currentPdfData = null; // å„²å­˜ç•¶å‰ PDF è³‡æ–™

      // DOM å…ƒç´ 
      const container = document.getElementById('viewerContainer');
      const pageNumberInput = document.getElementById('pageNumber');
      const numPages = document.getElementById('numPages');
      const previousButton = document.getElementById('previous');
      const nextButton = document.getElementById('next');
      const zoomInButton = document.getElementById('zoomIn');
      const zoomOutButton = document.getElementById('zoomOut');
      const zoomValueSpan = document.getElementById('zoomValue');
      const printButton = document.getElementById('print');
      const downloadButton = document.getElementById('download');
      const loadingBar = document.getElementById('loadingBar');
      const loadingBarProgress = loadingBar.querySelector('.progress');
      const fileInput = document.getElementById('fileInput');

      // åˆå§‹åŒ– PDF æŸ¥çœ‹å™¨
      function initPdfViewer() {
        const eventBus = new pdfjsViewer.EventBus();

        pdfLinkService = new pdfjsViewer.PDFLinkService({
          eventBus: eventBus,
        });

        const findController = new pdfjsViewer.PDFFindController({
          eventBus: eventBus,
          linkService: pdfLinkService,
        });

        pdfViewer = new pdfjsViewer.PDFViewer({
          container: container,
          eventBus: eventBus,
          linkService: pdfLinkService,
          findController: findController,
          renderer: 'canvas',
          textLayerMode: 2,
        });

        pdfLinkService.setViewer(pdfViewer);

        eventBus.on('pagechanging', function (evt) {
          pageNum = evt.pageNumber;
          updateUI();
        });

        eventBus.on('scalechanging', function (evt) {
          scale = evt.scale;
          updateZoomValue();
        });

        eventBus.on('progress', function (evt) {
          if (evt.total > 0) {
            const percent = Math.round((evt.loaded / evt.total) * 100);
            loadingBarProgress.style.width = percent + '%';
          }
        });

        eventBus.on('documentloaded', function () {
          loadingBar.style.display = 'none';
        });
      }

      /**
       * è¼‰å…¥ PDF
       * @param {string|Uint8Array} source - æª”æ¡ˆè·¯å¾‘ URL æˆ– ArrayBuffer è³‡æ–™
       */
      function loadPdf(source) {
        loadingBar.style.display = 'block';
        loadingBarProgress.style.width = '0%';

        // å„²å­˜ä¾†æºä»¥ä¾¿ (æœªä¾†å¯èƒ½çš„) ä½¿ç”¨
        if (typeof source !== 'string') {
          currentPdfData = source;
        } else {
          currentPdfData = null;
        }

        const loadingTask = pdfjsLib.getDocument(source);

        loadingTask.promise
          .then(function (pdf) {
            pdfDoc = pdf;
            numPages.textContent = pdf.numPages;
            pdfViewer.setDocument(pdf);
            pdfLinkService.setDocument(pdf);

            // é‡ç½®ç¸®æ”¾
            scale = 1.0;
            pdfViewer.currentScaleValue = 'auto';

            updateUI();
            console.log('PDF è¼‰å…¥æˆåŠŸ');
          })
          .catch(function (error) {
            console.error('è¼‰å…¥ PDF å¤±æ•—:', error);

            let msg = 'è¼‰å…¥å¤±æ•—: ' + error.message;
            if (
              typeof source === 'string' &&
              window.location.protocol === 'file:'
            ) {
              msg +=
                '\n\næ³¨æ„ï¼šç”±æ–¼ç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ (CORS)ï¼Œç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆæ™‚é€šå¸¸ç„¡æ³•è®€å–åŒç›®éŒ„çš„å…¶ä»–æª”æ¡ˆã€‚\nè«‹ä½¿ç”¨å·¦ä¸Šè§’çš„ã€Œé–‹å•Ÿ PDFã€æŒ‰éˆ•é¸å–æª”æ¡ˆã€‚';
            }
            alert(msg);
            loadingBar.style.display = 'none';
          });
      }

      function updateUI() {
        pageNumberInput.value = pageNum;
        previousButton.disabled = pageNum <= 1;
        nextButton.disabled = pageNum >= pdfDoc.numPages;
      }

      function updateZoomValue() {
        zoomValueSpan.textContent = Math.round(scale * 100) + '%';
      }

      // æŒ‰éˆ•äº‹ä»¶è™•ç†
      function onPrevPage() {
        if (pageNum > 1) {
          pageNum--;
          pdfViewer.currentPageNumber = pageNum;
        }
      }

      function onNextPage() {
        if (pageNum < pdfDoc.numPages) {
          pageNum++;
          pdfViewer.currentPageNumber = pageNum;
        }
      }

      function onZoomIn() {
        scale = Math.min(5, scale * 1.1);
        pdfViewer.currentScale = scale;
      }

      function onZoomOut() {
        scale = Math.max(0.1, scale / 1.1);
        pdfViewer.currentScale = scale;
      }

      function onPrint() {
        alert('æœ¬ç³»çµ±å·²ç¦ç”¨åˆ—å°åŠŸèƒ½ã€‚');
      }

      function onDownload() {
        alert('æœ¬ç³»çµ±å·²ç¦ç”¨ä¸‹è¼‰åŠŸèƒ½ã€‚');
      }

      // ç›£è½æª”æ¡ˆé¸å–
      fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const fileReader = new FileReader();
          fileReader.onload = function () {
            const typedarray = new Uint8Array(this.result);
            loadPdf(typedarray);
          };
          fileReader.readAsArrayBuffer(file);
        }
      });

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      previousButton.addEventListener('click', onPrevPage);
      nextButton.addEventListener('click', onNextPage);
      zoomInButton.addEventListener('click', onZoomIn);
      zoomOutButton.addEventListener('click', onZoomOut);
      printButton.addEventListener('click', onPrint);
      downloadButton.addEventListener('click', onDownload);

      pageNumberInput.addEventListener('change', function () {
        const val = parseInt(this.value);
        if (val >= 1 && val <= pdfDoc.numPages) {
          pageNum = val;
          pdfViewer.currentPageNumber = pageNum;
        } else {
          this.value = pageNum;
        }
      });

      // ç¦ç”¨å³éµé¸å–®
      document.addEventListener('contextmenu', (e) => e.preventDefault());

      // ç¦ç”¨éµç›¤å¿«æ·éµ (Ctrl+P, Ctrl+S)
      document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
          e.preventDefault();
          alert('æœ¬ç³»çµ±å·²ç¦ç”¨åˆ—å°åŠŸèƒ½ã€‚');
        }
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
          e.preventDefault();
          alert('æœ¬ç³»çµ±å·²ç¦ç”¨å„²å­˜åŠŸèƒ½ã€‚');
        }
      });

      // è¦–çª—å¤±å»ç„¦é»æ™‚æ¨¡ç³ŠåŒ–å…§å®¹ (é˜²æˆªåœ–è»Ÿé«”)
      window.addEventListener('blur', function () {
        document.body.classList.add('blurred');
        document.title = 'å…§å®¹ä¿è­·ä¸­...';
      });

      window.addEventListener('focus', function () {
        document.body.classList.remove('blurred');
        document.title = 'æœ¬åœ°é è¦½PDFç‰ˆ';
      });

      // åˆå§‹åŒ–
      initPdfViewer();

      // å˜—è©¦è‡ªå‹•è¼‰å…¥åŒç›®éŒ„ä¸‹çš„ report.pdf
      //loadPdf('report.pdf');
    </script>
  </body>
</html>
